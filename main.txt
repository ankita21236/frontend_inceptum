import { state } from './state.js';
import { api } from './api.js';
import { addEventToTimeline } from './ui.js';

// --- SOS Button ---
export async function handleSOS() { 
    if (!state.userMarker) { 
        alert("Cannot send SOS: Your location is not yet determined."); 
        return; 
    }
    
    const userLatLng = state.userMarker.getLatLng(); 
    const coords = `${userLatLng.lat.toFixed(6)}, ${userLatLng.lng.toFixed(6)}`;
    
    const sosData = { 
        userId: state.userData.mobile, 
        info: state.userData, 
        coordinates: { lat: userLatLng.lat, lng: userLatLng.lng } 
    };
    
    // Show loading state (optional but good UX)
    const sosButton = document.getElementById('sos-button');
    sosButton.disabled = true;
    sosButton.classList.remove('sos-pulse');
    sosButton.innerHTML = `<span id="sos-text" style="font-size: 4rem;">SEND...</span>`;

    const response = await api.sendSOS(sosData);
    
    if (response.success) {
        const primaryContact = state.userData.contacts[0]; 
        const otherContacts = state.userData.contacts.slice(1).filter(c => c.trim() !== "");
        let notificationList = `\n- Nearest Rescue Teams\n- Primary Contact: ${primaryContact}`;
        if (otherContacts.length > 0) { 
            notificationList += `\n- Other Contacts: ${otherContacts.join(', ')}`; 
        }
        
        alert(`SOS Activated for ${state.userData.name}!\n\nCoordinates: ${coords}\n\nNotifying:\n${notificationList}`);
        
        sosButton.style.backgroundColor = 'var(--color-success)';
        sosButton.innerHTML = `<span id="sos-text" style="font-size: 5rem;">SENT</span>`;
        
        addEventToTimeline('ğŸ†˜', `SOS beacon activated by ${state.userData.name}.`, 'danger');
    } else { 
        alert("SOS failed to send. Please check your connection."); 
        sosButton.disabled = false;
        sosButton.classList.add('sos-pulse');
        sosButton.innerHTML = `<span id="sos-text">SOS</span>`;
    }
}

// --- Save Additional Contacts ---
export async function saveAdditionalContacts() { 
    const newContacts = [state.userData.contacts[0]]; // Keep primary contact
    
    document.querySelectorAll('.additional-contact').forEach(input => { 
        if (input.value.trim() !== "") { 
            newContacts.push(input.value.trim()); 
        } 
    });
    
    // Update local state
    state.userData.contacts = newContacts;
    
    // Update localStorage
    const users = JSON.parse(localStorage.getItem('aegisUsers')) || {};
    if (users[state.userData.mobile]) {
        users[state.userData.mobile] = state.userData; // Save updated user data
        localStorage.setItem('aegisUsers', JSON.stringify(users));
        
        // Mock API call
        await api.saveContacts(state.userData.mobile, newContacts);
        
        alert("Additional contacts have been saved.");
    } else {
        alert("Error: Could not find user to save contacts.");
    }
}





// Mock video database
const videoDatabase = {
Â  Â  "earthquake": ["G3hfugS_6vU", "eXyVp3m5jB4"],
Â  Â  "flood": ["jyQ2At24T5I", "4ACa_g_dAO4"],
Â  Â  "safety": ["QUcatA-d2yM", "xsc-j8yqK2s"],
Â  Â  "disaster": ["xsc-j8yqK2s", "LdbS1V8vG5k"]
};

// Export the API object directly
export const api = {
Â  Â  async registerUser(userInfo) {
Â  Â  Â  Â  // Mock API call
Â  Â  Â  Â  return new Promise(resolve => setTimeout(() => resolve({ success: true, userId: `user_${Date.now()}` }), 500));
Â  Â  },
Â  Â  async sendSOS(sosData) {
Â  Â  Â  Â  // Mock API call
Â  Â  Â  Â  console.log("SOS Data Sent to Server:", sosData);
Â  Â  Â  Â  return new Promise(resolve => setTimeout(() => resolve({ success: true }), 800));
Â  Â  },
Â  Â  async getAIResponse(query) {
Â  Â  Â  Â  // Mock AI response
Â  Â  Â  Â  return new Promise(resolve => {
Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  let responsePoints = ["I provide general safety info. How can I help?"];
Â  Â  Â  Â  Â  Â  Â  Â  let videoIds = null;
Â  Â  Â  Â  Â  Â  Â  Â  const lowerInput = query.toLowerCase();

Â  Â  Â  Â  Â  Â  Â  Â  for (const key in videoDatabase) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (lowerInput.includes(key)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  videoIds = videoDatabase[key];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (lowerInput.includes("shelter")) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  responsePoints = ["Emergency shelters are at Green Park Stadium and Kanpur University."];
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  resolve({ success: true, text: responsePoints, videos: videoIds });
Â  Â  Â  Â  Â  Â  }, 1000);
Â  Â  Â  Â  });
Â  Â  },
Â  Â  async saveContacts(userId, contacts) {
Â  Â  Â  Â  // Mock API call
Â  Â  Â  Â  console.log(`Saving contacts for ${userId}:`, contacts);
Â  Â  Â  Â  return new Promise(resolve => setTimeout(() => resolve({ success: true }), 400));
Â  Â  }
};

import { state } from './state.js';

// --- REGISTRATION with inline error ---
export function handleRegister(e) {
Â  Â  e.preventDefault();
Â  Â  const errorEl = document.getElementById('register-error-message');
Â  Â  errorEl.textContent = ''; // Clear old errors

Â  Â  const users = JSON.parse(localStorage.getItem('aegisUsers')) || {};
Â  Â  const mobile = document.getElementById('reg-mobile').value;
Â  Â  
Â  Â  if (!mobile) {
Â  Â  Â  Â  errorEl.textContent = 'Mobile number is required.';
Â  Â  Â  Â  return;
Â  Â  }
Â  Â  if (users[mobile]) {
Â  Â  Â  Â  errorEl.textContent = 'User with this mobile already exists.';
Â  Â  Â  Â  return;
Â  Â  }
Â  Â  
Â  Â  const newUser = {
Â  Â  Â  Â  name: document.getElementById('reg-name').value,
Â  Â  Â  Â  age: document.getElementById('reg-age').value,
Â  Â  Â  Â  mobile: mobile,
Â  Â  Â  Â  contacts: [document.getElementById('reg-contact').value],
Â  Â  Â  Â  password: document.getElementById('reg-password').value 
Â  Â  };

Â  Â  if (!newUser.name || !newUser.age || !newUser.contacts[0] || !newUser.password) {
Â  Â  Â  Â  errorEl.textContent = 'Please fill in all fields.';
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  users[mobile] = newUser;
Â  Â  localStorage.setItem('aegisUsers', JSON.stringify(users));
Â  Â  
Â  Â  alert('Registration successful! Please log in.');
Â  Â  document.getElementById('toggle-to-login').click();
}

// --- LOGIN with inline error ---
export function handleLogin(e) {
Â  Â  e.preventDefault();
Â  Â  const errorEl = document.getElementById('login-error-message');
Â  Â  errorEl.textContent = ''; // Clear old errors

Â  Â  const users = JSON.parse(localStorage.getItem('aegisUsers')) || {};
Â  Â  const mobile = document.getElementById('login-mobile').value;
Â  Â  const password = document.getElementById('login-password').value;
Â  Â  const registeredUser = users[mobile];

Â  Â  if (registeredUser && registeredUser.password === password) {
Â  Â  Â  Â  // --- SUCCESS ---
Â  Â  Â  Â  return registeredUser; // Return the user object
Â  Â  } else {
Â  Â  Â  Â  // --- FAIL ---
Â  Â  Â  Â  errorEl.textContent = 'Invalid mobile number or password.';
Â  Â  Â  Â  return null; // Return null on failure
Â  Â  }
}

// --- LOGOUT ---
export function handleLogout() {
Â  Â  location.reload(); // Simple reload to go back to login screen
}

import { api } from './api.js'; // Import the mock API

// This function is only used internally, so we don't export it
function addMessageToChat(message, sender, videoIds = null) {
Â  Â  const chatWindow = document.getElementById('chat-window');
Â  Â  const wrapper = document.createElement('div');
Â  Â  wrapper.className = `chat-msg-wrapper ${sender}`;
Â  Â  let contentHTML = '';

Â  Â  if (sender === 'ai') {
Â  Â  Â  Â  // Handle array of messages
Â  Â  Â  Â  const points = Array.isArray(message) ? message : [message];
Â  Â  Â  Â  const bulletPoints = points.map(point => `<li>${point}</li>`).join('');
Â  Â  Â  Â  contentHTML += `<ul class="list-disc list-inside space-y-2">${bulletPoints}</ul>`;
Â  Â  Â  Â  
Â  Â  Â  Â  if (videoIds && videoIds.length > 0) {
Â  Â  Â  Â  Â  Â  contentHTML += `<h4>Related Videos:</h4>`;
Â  Â  Â  Â  Â  Â  videoIds.forEach(videoId => {
Â  Â  Â  Â  Â  Â  Â  Â  contentHTML += `<div class="video-container"><iframe src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe></div>`;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  } else {
Â  Â  Â  Â  contentHTML = `<p>${message}</p>`;
Â  Â  }
Â  Â  wrapper.innerHTML = `<div class="chat-msg ${sender}">${contentHTML}</div>`;
Â  Â  chatWindow.appendChild(wrapper);
Â  Â  chatWindow.scrollTop = chatWindow.scrollHeight;
}

// This function is exported to be used in main.js
export async function handleChatSubmit(e) {
Â  Â  e.preventDefault();
Â  Â  const chatInput = document.getElementById('chat-input');
Â  Â  const userInput = chatInput.value.trim();
Â  Â  if (!userInput) return;

Â  Â  addMessageToChat(`<strong>Your Query:</strong><br>${userInput}`, 'user');
Â  Â  chatInput.value = '';

Â  Â  // --- UI/UX IMPROVEMENT ---
Â  Â  // 1. Create and add the "typing..." indicator
Â  Â  const chatWindow = document.getElementById('chat-window');
Â  Â  const typingIndicator = document.createElement('div');
Â  Â  typingIndicator.className = 'chat-msg-wrapper ai';
Â  Â  typingIndicator.id = 'typing-indicator'; // Give it an ID
Â  Â  typingIndicator.innerHTML = `<div class="chat-msg ai">AI is typing...</div>`;
Â  Â  chatWindow.appendChild(typingIndicator);
Â  Â  chatWindow.scrollTop = chatWindow.scrollHeight;
Â  Â  // -------------------------

Â  Â  const response = await api.getAIResponse(userInput);

Â  Â  // --- UI/UX IMPROVEMENT ---
Â  Â  // 2. Remove the "typing..." indicator
Â  Â  document.getElementById('typing-indicator').remove();
Â  Â  // -------------------------

Â  Â  if (response.success) {
Â  Â  Â  Â  addMessageToChat(response.text, 'ai', response.videos);
Â  Â  } else {
Â  Â  Â  Â  addMessageToChat(["Sorry, I'm having trouble connecting."], 'ai');
Â  Â  }
}

// Global variables for this module
let globeModuleRenderer, globeModuleAnimatorId;

export function initGlobeModule() {
Â  Â  const globeModuleContainer = document.getElementById('globe-module-canvas');
Â  Â  if (typeof THREE !== 'undefined' && !globeModuleRenderer && globeModuleContainer) {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const scene = new THREE.Scene();
Â  Â  Â  Â  Â  Â  const camera = new THREE.PerspectiveCamera(40, globeModuleContainer.clientWidth / globeModuleContainer.clientHeight, 0.1, 1000); 
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  globeModuleRenderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
Â  Â  Â  Â  Â  Â  globeModuleRenderer.setSize(globeModuleContainer.clientWidth, globeModuleContainer.clientHeight);
Â  Â  Â  Â  Â  Â  globeModuleRenderer.setClearColor(0x000000, 0); // Transparent background
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  globeModuleContainer.appendChild(globeModuleRenderer.domElement);

Â  Â  Â  Â  Â  Â  // --- UI/UX IMPROVEMENT: ADD ORBIT CONTROLS ---
Â  Â  Â  Â  Â  Â  const controls = new THREE.OrbitControls(camera, globeModuleRenderer.domElement);
Â  Â  Â  Â  Â  Â  controls.enableDamping = true; // Makes rotation smoother
Â  Â  Â  Â  Â  Â  controls.dampingFactor = 0.05;
Â  Â  Â  Â  Â  Â  controls.screenSpacePanning = false;
Â  Â  Â  Â  Â  Â  controls.minDistance = 2.5; // Don't let user zoom in too far
Â  Â  Â  Â  Â  Â  controls.maxDistance = 6; Â  // Don't let user zoom out too far
Â  Â  Â  Â  Â  Â  controls.autoRotate = true; // Keep it spinning
Â  Â  Â  Â  Â  Â  controls.autoRotateSpeed = 0.5; // Slower default spin
Â  Â  Â  Â  Â  Â  // ---------------------------------------------

Â  Â  Â  Â  Â  Â  // Adjusted lights for a realistic surface
Â  Â  Â  Â  Â  Â  scene.add(new THREE.AmbientLight(0x222222)); // Less ambient
Â  Â  Â  Â  Â  Â  const dirLight = new THREE.DirectionalLight(0xffffff, 1.2); // Brighter directional
Â  Â  Â  Â  Â  Â  dirLight.position.set(5, 3, 5);
Â  Â  Â  Â  Â  Â  scene.add(dirLight);

Â  Â  Â  Â  Â  Â  const loader = new THREE.TextureLoader();
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // --- 1. The "Real" Earth ---
Â  Â  Â  Â  Â  Â  const globeGeometry = new THREE.SphereGeometry(1.5, 64, 64);
Â  Â  Â  Â  Â  Â  const globeMaterial = new THREE.MeshPhongMaterial({
Â  Â  Â  Â  Â  Â  Â  Â  map: loader.load('https://raw.githubusercontent.com/tensorspace-team/tensorspace/master/assets/images/earth.png'),
Â  Â  Â  Â  Â  Â  Â  Â  specularMap: loader.load('https://raw.githubusercontent.com/tensorspace-team/tensorspace/master/assets/images/specular.png'),
Â  Â  Â  Â  Â  Â  Â  Â  specular: new THREE.Color(0x111111),
Â  Â  Â  Â  Â  Â  Â  Â  emissiveMap: loader.load('https://raw.githubusercontent.com/tensorspace-team/tensorspace/master/assets/images/earth_night.jpg'),
Â  Â  Â  Â  Â  Â  Â  Â  emissive: new THREE.Color(0xffffff),
Â  Â  Â  Â  Â  Â  Â  Â  emissiveIntensity: 1.0
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const globeModuleMesh = new THREE.Mesh(globeGeometry, globeMaterial); // This is the main Earth
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Rotate to center India
Â  Â  Â  Â  Â  Â  globeModuleMesh.rotation.y = -1.34; // approx 77Â° E
Â  Â  Â  Â  Â  Â  globeModuleMesh.rotation.x = -0.35; // approx 20Â° N

Â  Â  Â  Â  Â  Â  scene.add(globeModuleMesh);

Â  Â  Â  Â  Â  Â  // --- 2. The Cloud Layer ---
Â  Â  Â  Â  Â  Â  const cloudGeometry = new THREE.SphereGeometry(1.51, 64, 64); // Slightly larger
Â  Â  Â  Â  Â  Â  const cloudMaterial = new THREE.MeshPhongMaterial({
Â  Â  Â  Â  Â  Â  Â  Â  map: loader.load('https://raw.githubusercontent.com/tensorspace-team/tensorspace/master/assets/images/cloud.png'),
Â  Â  Â  Â  Â  Â  Â  Â  transparent: true,
Â  Â  Â  Â  Â  Â  Â  Â  opacity: 0.25,
Â  Â  Â  Â  Â  Â  Â  Â  blending: THREE.AdditiveBlending
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  const globeCloudMesh = new THREE.Mesh(cloudGeometry, cloudMaterial); // Assign to global
Â  Â  Â  Â  Â  Â  scene.add(globeCloudMesh);


Â  Â  Â  Â  Â  Â  // --- 3. The Atmosphere Glow ---
Â  Â  Â  Â  Â  Â  const glowGeometry = new THREE.SphereGeometry(1.55, 64, 64); // Slightly larger
Â  Â  Â  Â  Â  Â  const glowMaterial = new THREE.ShaderMaterial({
Â  Â  Â  Â  Â  Â  Â  Â  uniforms: { 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'c': { type: 'f', value: 0.4 }, // Softer glow
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'p': { type: 'f', value: 3.0 }, // Less sharp
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  vertexShader: `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  varying vec3 vNormal;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  void main() {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  vNormal = normalize( normalMatrix * normal );
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  `,
Â  Â  Â  Â  Â  Â  Â  Â  fragmentShader: `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  uniform float c;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  uniform float p;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  varying vec3 vNormal;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  void main() {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  float intensity = pow( c - dot( vNormal, vec3( 0.0, 0.0, 1.0 ) ), p );
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Make atmosphere glow a realistic blue
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  gl_FragColor = vec4( 0.5, 0.8, 1.0, 1.0 ) * intensity * 0.8; 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  `,
Â  Â  Â  Â  Â  Â  Â  Â  side: THREE.BackSide,
Â  Â  Â  Â  Â  Â  Â  Â  blending: THREE.AdditiveBlending,
Â  Â  Â  Â  Â  Â  Â  Â  transparent: true
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  const glowMesh = new THREE.Mesh(glowGeometry, glowMaterial);
Â  Â  Â  Â  Â  Â  scene.add(glowMesh);

Â  Â  Â  Â  Â  Â  camera.position.z = 3.5;

Â  Â  Â  Â  Â  Â  const animateModule = () => {
Â  Â  Â  Â  Â  Â  Â  Â  globeModuleAnimatorId = requestAnimationFrame(animateModule);
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // --- UI/UX IMPROVEMENT: UPDATE CONTROLS ---
Â  Â  Â  Â  Â  Â  Â  Â  controls.update(); // This is crucial for smooth controls

Â  Â  Â  Â  Â  Â  Â  Â  // We can let clouds rotate independently
Â  Â  Â  Â  Â  Â  Â  Â  globeCloudMesh.rotation.y += 0.0002;
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  globeModuleRenderer.render(scene, camera);
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  animateModule();

Â  Â  Â  Â  Â  Â  // Handle window resize
Â  Â  Â  Â  Â  Â  window.addEventListener('resize', () => {
Â  Â  Â  Â  Â  Â  Â  Â  if(globeModuleRenderer && globeModuleContainer) { 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  camera.aspect = globeModuleContainer.clientWidth / globeModuleContainer.clientHeight;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  camera.updateProjectionMatrix();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  globeModuleRenderer.setSize(globeModuleContainer.clientWidth, globeModuleContainer.clientHeight);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  console.error("Error initializing Globe Module:", e);
Â  Â  Â  Â  Â  Â  globeModuleContainer.innerHTML = "<p style='color: var(--color-alert);'>Error loading 3D Globe.</p>";
Â  Â  Â  Â  }
Â  Â  }
}

// --- Import Application State ---
import { state } from './state.js';

// --- Import Initializers ---
import { initMap, toggleMapTheme, switchMapView } from './map.js';
import { initGlobeModule } from './globe.js';
import { initParticleAnimation, showPage, stopAlert, addEventToTimeline } from './ui.js';

// --- Import Event Handlers ---
import { handleRegister, handleLogin, handleLogout } from './auth.js';
import { handleChatSubmit } from './chat.js';
import { handleSOS, saveAdditionalContacts } from './actions.js';

// NEW: Import stats module
import { initStatsModule } from './stats.js';


// --- Main App Initialization ---
document.addEventListener('DOMContentLoaded', () => {

Â  Â  // --- Element Selections ---
Â  Â  const registerForm = document.getElementById('register-form');
Â  Â  const loginForm = document.getElementById('login-form');
Â  Â  const logoutBtn = document.getElementById('logout-btn');
Â  Â  const toggleToLogin = document.getElementById('toggle-to-login');
Â  Â  const toggleToRegister = document.getElementById('toggle-to-register');
Â  Â  const navButtons = document.querySelectorAll('.nav-btn');
Â  Â  const backButtons = document.querySelectorAll('.nav-back');
Â  Â  const chatForm = document.getElementById('chat-form');
Â  Â  const sosButton = document.getElementById('sos-button');
Â  Â  const stopAlertButton = document.getElementById('stop-alert-button');
Â  Â  const saveContactsBtn = document.getElementById('save-contacts-btn');
Â  Â  const toggleAdvisoryBtn = document.getElementById('toggle-advisory-btn');
Â  Â  const mapControlButtons = document.querySelectorAll('.map-control-btn');
Â  Â  
Â  Â  // --- Initialize Vanta.js for Login Page ---
Â  Â  if (typeof VANTA !== 'undefined') {
Â  Â  Â  Â  state.vantaEffect = VANTA.GLOBE({
Â  Â  Â  Â  Â  Â  el: "#login-page",
Â  Â  Â  Â  Â  Â  mouseControls: true,
Â  Â  Â  Â  Â  Â  touchControls: true,
Â  Â  Â  Â  Â  Â  gyroControls: false,
Â  Â  Â  Â  Â  Â  minHeight: 200.00,
Â  Â  Â  Â  Â  Â  minWidth: 200.00,
Â  Â  Â  Â  Â  Â  scale: 1.00,
Â  Â  Â  Â  Â  Â  scaleMobile: 1.00,
Â  Â  Â  Â  Â  Â  color: 0x00ffff,
Â  Â  Â  Â  Â  Â  color2: 0x0ea5e9,
Â  Â  Â  Â  Â  Â  backgroundColor: 0x020a18,
Â  Â  Â  Â  Â  Â  size: 1.20
Â  Â  Â  Â  });
Â  Â  }
Â  Â  document.body.classList.add('on-login-page');

Â  Â  // --- Attach Event Listeners ---

Â  Â  // Auth
Â  Â  registerForm.addEventListener('submit', handleRegister);
Â  Â  
Â  Â  // --- UPDATED LOGIN HANDLER ---
Â  Â  loginForm.addEventListener('submit', (e) => {
Â  Â  Â  Â  const user = handleLogin(e); // Get result from auth function
Â  Â  Â  Â  if (user) {
Â  Â  Â  Â  Â  Â  performLogin(user); // Call login logic HERE
Â  Â  Â  Â  }
Â  Â  });
Â  Â  
Â  Â  logoutBtn.addEventListener('click', handleLogout);
Â  Â  
Â  Â  toggleToLogin.addEventListener('click', () => {
Â  Â  Â  Â  toggleToLogin.classList.add('active');
Â  Â  Â  Â  toggleToRegister.classList.remove('active');
Â  Â  Â  Â  loginForm.classList.add('active');
Â  Â  Â  Â  registerForm.classList.remove('active');
Â  Â  });
Â  Â  toggleToRegister.addEventListener('click', () => {
Â  Â  Â  Â  toggleToRegister.classList.add('active');
Â  Â  Â  Â  toggleToLogin.classList.remove('active');
Â  Â  Â  Â  registerForm.classList.add('active');
Â  Â  Â  Â  loginForm.classList.remove('active');
Â  Â  });

Â  Â  // Navigation
Â  Â  navButtons.forEach(button => button.addEventListener('click', () => {
Â  Â  Â  Â  const targetId = button.dataset.target;
Â  Â  Â  Â  if (targetId) {
Â  Â  Â  Â  Â  Â  showPage(targetId);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // NEW: Initialize stats module only when clicked
Â  Â  Â  Â  Â  Â  if (targetId === 'module4-stats') {
Â  Â  Â  Â  Â  Â  Â  Â  initStatsModule();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  }));
Â  Â  backButtons.forEach(button => button.addEventListener('click', () => showPage('home-dashboard')));

Â  Â  // Modules & Actions
Â  Â  chatForm.addEventListener('submit', handleChatSubmit);
Â  Â  sosButton.addEventListener('click', handleSOS);
Â  Â  saveContactsBtn.addEventListener('click', saveAdditionalContacts);
Â  Â  stopAlertButton.addEventListener('click', stopAlert);

Â  Â  // Map Controls
Â  Â  mapControlButtons.forEach(btn => {
Â  Â  Â  Â  btn.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  if (btn.id === 'btn-draw-zone') { return; } // Drawing is handled in map.js
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (btn.id === 'btn-theme') { 
Â  Â  Â  Â  Â  Â  Â  Â  toggleMapTheme(); 
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // Handle map view switching
Â  Â  Â  Â  Â  Â  Â  Â  btn.parentElement.querySelectorAll('.map-control-btn').forEach(b => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(b !== btn) b.classList.remove('active');
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  btn.classList.add('active');
Â  Â  Â  Â  Â  Â  Â  Â  switchMapView(btn.id);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  });

Â  Â  // UI Toggles
Â  Â  toggleAdvisoryBtn.addEventListener('click', () => {
Â  Â  Â  Â  const disasterFeedSection = document.getElementById('disaster-feed-section');
Â  Â  Â  Â  const historyAdvisorySection = document.getElementById('history-advisory-section');
Â  Â  Â  Â  const isHidden = disasterFeedSection.classList.contains('hidden');
Â  Â  Â  Â  
Â  Â  Â  Â  disasterFeedSection.classList.toggle('hidden');
Â  Â  Â  Â  historyAdvisorySection.classList.toggle('hidden');
Â  Â  Â  Â  toggleAdvisoryBtn.textContent = isHidden ? 'Hide Disaster Intel' : 'Show Disaster Intel';
Â  Â  });
});

// --- MOVED performLogin() HERE ---
function performLogin(loggedInUserData) {
Â  Â  state.userData = loggedInUserData; 
Â  Â  
Â  Â  // Destroy the Vanta.js animation
Â  Â  if (state.vantaEffect) {
Â  Â  Â  Â  state.vantaEffect.destroy();
Â  Â  Â  Â  state.vantaEffect = null;
Â  Â  }

Â  Â  // Show the main dashboard
Â  Â  document.getElementById('login-page').classList.add('hidden');
Â  Â  document.getElementById('main-dashboard').classList.remove('hidden');
Â  Â  document.body.classList.remove('on-login-page');

Â  Â  // Populate user data into the UI
Â  Â  document.getElementById('profile-name').textContent = state.userData.name;
Â  Â  document.getElementById('profile-age').textContent = state.userData.age;
Â  Â  document.getElementById('profile-mobile').textContent = state.userData.mobile;
Â  Â  document.getElementById('profile-contact').textContent = state.userData.contacts[0] || 'N/A';
Â  Â  document.getElementById('globe-operator-name').textContent = state.userData.name; 
Â  Â  
Â  Â  // Populate additional contacts
Â  Â  const contactInputs = document.querySelectorAll('.additional-contact');
Â  Â  state.userData.contacts.slice(1).forEach((contact, index) => {
Â  Â  Â  Â  if (contactInputs[index]) {
Â  Â  Â  Â  Â  Â  contactInputs[index].value = contact;
Â  Â  Â  Â  }
Â  Â  });

Â  Â  document.getElementById('dashboard-location').textContent = `Location: Kanpur, Uttar Pradesh | Operator: ${state.userData.name}`;
Â  Â  
Â  Â  // Initialize the main app components
Â  Â  initDashboard();
Â  Â  initGlobeModule();
}

// --- Dashboard Initializer (called by performLogin) ---
function initDashboard() {
Â  Â  initMap();
Â  Â  addEventToTimeline('âœ…', 'Aegis Protocol Initialized.');
Â  Â  initParticleAnimation(); // Start particles AFTER login
Â  Â  
Â  Â  // We don't init stats here, we wait for the user to click the tab.
}


import { state } from './state.js';
import { addEventToTimeline, triggerAlert } from './ui.js';

const KANPUR_COORDS = [26.4499, 80.3319];
let polygonDrawer; // To hold the Leaflet.Draw instance

// --- Main Map Initializer ---
export function initMap() {
Â  Â  if (state.map) return;
Â  Â  
Â  Â  state.map = L.map('map').setView(KANPUR_COORDS, 13);
Â  Â  
Â  Â  // Define Tile Layers
Â  Â  state.tileLayers.dark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; CartoDB' });
Â  Â  state.tileLayers.light = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; CartoDB' });
Â  Â  state.tileLayers.satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: '&copy; Esri' });
Â  Â  state.tileLayers.radar = L.tileLayer('https://tilecache.rainviewer.com/v2/radar/{z}/{x}/{y}/256/{ts}/1_0.png', { ts: Math.floor(Date.now() / 1000), opacity: 0.7, attribution: 'RainViewer' });

Â  Â  // Set initial theme
Â  Â  state.tileLayers.dark.addTo(state.map);
Â  Â  state.map.getContainer().classList.add('dark-theme');
Â  Â  state.isNightMode = true;
Â  Â  document.getElementById('btn-theme').innerHTML = "â˜€ï¸ Day Mode";
Â  Â  
Â  Â  // Locate user
Â  Â  state.map.locate({watch: true, setView: true, maxZoom: 16, enableHighAccuracy: true});
Â  Â  state.map.on('locationfound', onLocationFound);

Â  Â  // Add layers and markers
Â  Â  state.reportedHazards = L.layerGroup().addTo(state.map);
Â  Â  addResourceMarkers();

Â  Â  // Right-click to report hazard
Â  Â  state.map.on('contextmenu', function(e) { 
Â  Â  Â  Â  L.marker(e.latlng, { icon: L.divIcon({ className: 'text-2xl', html: 'âš ï¸' }) })
Â  Â  Â  Â  Â  Â  .addTo(state.reportedHazards)
Â  Â  Â  Â  Â  Â  .bindPopup(`Hazard reported`)
Â  Â  Â  Â  Â  Â  .openPopup(); 
Â  Â  });

Â  Â  // Initial simulated disaster zone
Â  Â  const initialRedCoords = [[26.48, 80.38], [26.48, 80.42], [26.45, 80.42], [26.45, 80.38]];
Â  Â  state.redZonePolygon = L.polygon(initialRedCoords, { color: '#ef4444', fillColor: '#ef4444', fillOpacity: 0.4, weight: 1 }).addTo(state.map);
Â  Â  
Â  Â  // Start simulation
Â  Â  setInterval(simulateDisaster, 4000);

Â  Â  // Init Leaflet.draw
Â  Â  initDrawing();
}

// --- Map Helper Functions ---

function onLocationFound(e) {
Â  Â  if (!state.userMarker) {
Â  Â  Â  Â  // Create user marker
Â  Â  Â  Â  state.userMarker = L.marker(e.latlng, { 
Â  Â  Â  Â  Â  Â  icon: L.divIcon({ 
Â  Â  Â  Â  Â  Â  Â  Â  className: 'user-marker', 
Â  Â  Â  Â  Â  Â  Â  Â  html: '<div></div>', 
Â  Â  Â  Â  Â  Â  Â  Â  iconSize: [16, 16] 
Â  Â  Â  Â  Â  Â  }) 
Â  Â  Â  Â  }).addTo(state.map);
Â  Â  Â  Â  
Â  Â  Â  Â  // Add CSS for the marker pulse
Â  Â  Â  Â  const style = document.createElement('style');
Â  Â  Â  Â  style.innerHTML = `
Â  Â  Â  Â  Â  Â  .user-marker div { 
Â  Â  Â  Â  Â  Â  Â  Â  width: 16px; height: 16px; background: var(--color-accent); 
Â  Â  Â  Â  Â  Â  Â  Â  border-radius: 50%; border: 2px solid white; 
Â  Â  Â  Â  Â  Â  Â  Â  box-shadow: 0 0 10px var(--color-accent); 
Â  Â  Â  Â  Â  Â  Â  Â  animation: pulse-user 1.5s infinite; 
Â  Â  Â  Â  Â  Â  } 
Â  Â  Â  Â  Â  Â  @keyframes pulse-user { 
Â  Â  Â  Â  Â  Â  Â  Â  0% { transform: scale(1); opacity: 1; } 
Â  Â  Â  Â  Â  Â  Â  Â  50% { transform: scale(1.5); opacity: 0.5; } 
Â  Â  Â  Â  Â  Â  Â  Â  100% { transform: scale(1); opacity: 1; } 
Â  Â  Â  Â  Â  Â  }`;
Â  Â  Â  Â  if(!document.head.querySelector('.user-marker-style')) {
Â  Â  Â  Â  Â  Â  Â style.className = 'user-marker-style';
Â  Â  Â  Â  Â  Â  Â document.head.appendChild(style);
Â  Â  Â  Â  }
Â  Â  } else {
Â  Â  Â  Â  // Update marker position
Â  Â  Â  Â  state.userMarker.setLatLng(e.latlng); 
Â  Â  }
}

function addResourceMarkers() {
Â  Â  const resources = [ 
Â  Â  Â  Â  { name: 'Regency Hospital', coords: [26.4748, 80.3421], icon: 'ğŸ¥' }, 
Â  Â  Â  Â  { name: 'GSVM Medical College', coords: [26.4589, 80.3061], icon: 'ğŸ¥' }, 
Â  Â  Â  Â  { name: 'Green Park Stadium (Shelter)', coords: [26.4715, 80.3499], icon: 'ğŸ ' }, 
Â  Â  Â  Â  { name: 'Kanpur Central (Police Post)', coords: [26.4533, 80.3516], icon: 'ğŸ‘®' } 
Â  Â  ];
Â  Â  resources.forEach(res => { 
Â  Â  Â  Â  L.marker(res.coords, { icon: L.divIcon({ className: 'text-2xl', html: res.icon }) })
Â  Â  Â  Â  Â  Â  .addTo(state.map)
Â  Â  Â  Â  Â  Â  .bindPopup(res.name); 
Â  Â  });
}

export function toggleMapTheme() {
Â  Â  state.isNightMode = !state.isNightMode;
Â  Â  const themeBtn = document.getElementById('btn-theme');
Â  Â  if (state.isNightMode) {
Â  Â  Â  Â  if (state.map.hasLayer(state.tileLayers.light)) state.map.removeLayer(state.tileLayers.light);
Â  Â  Â  Â  if (!state.map.hasLayer(state.tileLayers.dark)) state.tileLayers.dark.addTo(state.map);
Â  Â  Â  Â  themeBtn.innerHTML = "â˜€ï¸ Day Mode";
Â  Â  } else {
Â  Â  Â  Â  if (state.map.hasLayer(state.tileLayers.dark)) state.map.removeLayer(state.tileLayers.dark);
Â  Â  Â  Â  if (!state.map.hasLayer(state.tileLayers.light)) state.tileLayers.light.addTo(state.map);
Â  Â  Â  Â  themeBtn.innerHTML = "ğŸŒ™ Night Mode";
Â  Â  }
}

export function switchMapView(viewId) {
Â  Â  if (state.map.hasLayer(state.tileLayers.satellite)) state.map.removeLayer(state.tileLayers.satellite);
Â  Â  if (state.map.hasLayer(state.tileLayers.radar)) state.map.removeLayer(state.tileLayers.radar);
Â  Â  
Â  Â  if (viewId === 'btn-satellite') { 
Â  Â  Â  Â  state.tileLayers.satellite.addTo(state.map); 
Â  Â  } else if (viewId === 'btn-radar') {
Â  Â  Â  Â  state.tileLayers.radar.options.ts = Math.floor(Date.now() / 1000);
Â  Â  Â  Â  state.tileLayers.radar.addTo(state.map);
Â  Â  }
Â  Â  addEventToTimeline('ğŸ—ºï¸', `Map view switched to ${viewId.replace('btn-', '')}.`, 'info');
}

function simulateDisaster() {
Â  Â  if (!state.redZonePolygon || !state.userMarker) return;
Â  Â  
Â  Â  // Expand the simulated zone
Â  Â  const currentCoords = state.redZonePolygon.getLatLngs()[0];
Â  Â  const newCoords = currentCoords.map(coord => ({ lat: coord.lat - 0.002, lng: coord.lng - 0.004 }));
Â  Â  state.redZonePolygon.setLatLngs(newCoords);
Â  Â  if (Math.random() > 0.8) { 
Â  Â  Â  Â  addEventToTimeline('ğŸ“ˆ', 'Danger zone has expanded.', 'warning'); 
Â  Â  }
Â  Â  
Â  Â  // Check user location against zones
Â  Â  const userLatLng = state.userMarker.getLatLng();
Â  Â  const inSimZone = state.redZonePolygon.getBounds().contains(userLatLng);
Â  Â  
Â  Â  let inManualZone = false;
Â  Â  if (state.manualRedZone && typeof state.manualRedZone.getBounds === 'function' && state.manualRedZone.getBounds().contains(userLatLng)) {
Â  Â  Â  Â inManualZone = true;
Â  Â  }

Â  Â  // Trigger alert if in a zone and alert is not already showing
Â  Â  if ((inSimZone || inManualZone) && document.getElementById('alert-popup').classList.contains('hidden')) { 
Â  Â  Â  Â  triggerAlert(); 
Â  Â  }
}

function initDrawing() {
Â  Â  const btnDrawZone = document.getElementById('btn-draw-zone'); 
Â  Â  if (typeof L.Draw !== 'undefined') {
Â  Â  Â  Â  polygonDrawer = new L.Draw.Polygon(state.map, {
Â  Â  Â  Â  Â  Â  shapeOptions: { color: '#f74040', fillColor: '#f74040', fillOpacity: 0.4 },
Â  Â  Â  Â  Â  Â  showArea: false 
Â  Â  Â  Â  });
Â  Â  Â  Â  
Â  Â  Â  Â  btnDrawZone.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  polygonDrawer.enable();
Â  Â  Â  Â  Â  Â  btnDrawZone.textContent = 'Drawing...';
Â  Â  Â  Â  Â  Â  btnDrawZone.classList.add('active');
Â  Â  Â  Â  });

Â  Â  Â  Â  state.map.on(L.Draw.Event.CREATED, function (e) {
Â  Â  Â  Â  Â  Â  const layer = e.layer;
Â  Â  Â  Â  Â  Â  if (state.manualRedZone) { state.map.removeLayer(state.manualRedZone); }
Â  Â  Â  Â  Â  Â  state.manualRedZone = layer;
Â  Â  Â  Â  Â  Â  state.manualRedZone.setStyle({ color: '#f74040', fillColor: '#f74040', fillOpacity: 0.4, weight: 1 });
Â  Â  Â  Â  Â  Â  state.map.addLayer(state.manualRedZone);
Â  Â  Â  Â  Â  Â  addEventToTimeline('âœï¸', 'Manual danger zone created.', 'warn');
Â  Â  Â  Â  Â  Â  btnDrawZone.textContent = 'Draw Manual Zone';
Â  Â  Â  Â  Â  Â  btnDrawZone.classList.remove('active');
Â  Â  Â  Â  });

Â  Â  Â  Â  state.map.on('draw:drawstop', function () {
Â  Â  Â  Â  Â  Â  polygonDrawer.disable();
Â  Â  Â  Â  Â  Â  btnDrawZone.textContent = 'Draw Manual Zone';
Â  Â  Â  Â  Â  Â  btnDrawZone.classList.remove('active');
Â  Â  Â  Â  });
Â  Â  } else {
Â  Â  Â  Â  console.error("Leaflet.draw library not loaded correctly!");
Â  Â  Â  Â  btnDrawZone.disabled = true;
Â  Â  Â  Â  btnDrawZone.textContent = 'Draw Unavailable';
Â  Â  }
}


// This object holds all shared data for the application.
// Other modules will import this to read or write state.
export const state = {
Â  Â  // Map State
Â  Â  map: null,
Â  Â  userMarker: null,
Â  Â  redZonePolygon: null,
Â  Â  manualRedZone: null,
Â  Â  tileLayers: {},
Â  Â  isNightMode: false,
Â  Â  reportedHazards: null,
Â  Â  
Â  Â  // User State
Â  Â  userData: {}, // Will be populated on login
Â  Â  
Â  Â  // UI State
Â  Â  vantaEffect: null // Holds the login page Vanta.js instance
};



let hazardChart = null;
let resourceChart = null;

// Mock data for the charts
const hazardData = {
Â  Â  labels: ['Floods', 'Wildfires', 'Earthquakes', 'Storms'],
Â  Â  datasets: [{
Â  Â  Â  Â  label: 'Reported Incidents',
Â  Â  Â  Â  data: [12, 5, 2, 8],
Â  Â  Â  Â  backgroundColor: [
Â  Â  Â  Â  Â  Â  'rgba(0, 150, 255, 0.7)',
Â  Â  Â  Â  Â  Â  'rgba(255, 159, 64, 0.7)',
Â  Â  Â  Â  Â  Â  'rgba(153, 102, 255, 0.7)',
Â  Â  Â  Â  Â  Â  'rgba(75, 192, 192, 0.7)'
Â  Â  Â  Â  ],
Â  Â  Â  Â  borderColor: 'rgba(230, 241, 255, 0.5)',
Â  Â  Â  Â  borderWidth: 1
Â  Â  }]
};

const resourceData = {
Â  Â  labels: ['Shelters', 'Medical Teams', 'Police Units', 'Food Supplies'],
Â  Â  datasets: [{
Â  Â  Â  Â  label: 'Capacity / Availability %',
Â  Â  Â  Â  data: [65, 80, 75, 45],
Â  Â  Â  Â  backgroundColor: 'rgba(0, 255, 255, 0.2)',
Â  Â  Â  Â  borderColor: 'rgba(0, 255, 255, 1)',
Â  Â  Â  Â  borderWidth: 2,
Â  Â  Â  Â  pointBackgroundColor: 'rgba(0, 255, 255, 1)',
Â  Â  Â  Â  pointBorderColor: '#fff',
Â  Â  Â  Â  pointHoverBackgroundColor: '#fff',
Â  Â  Â  Â  pointHoverBorderColor: 'rgba(0, 255, 255, 1)'
Â  Â  }]
};

export function initStatsModule() {
Â  Â  // Check if Chart.js is loaded
Â  Â  if (typeof Chart === 'undefined') {
Â  Â  Â  Â  console.error('Chart.js is not loaded!');
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  const hazardCtx = document.getElementById('hazardChart');
Â  Â  if (hazardCtx && !hazardChart) {
Â  Â  Â  Â  hazardChart = new Chart(hazardCtx, {
Â  Â  Â  Â  Â  Â  type: 'doughnut',
Â  Â  Â  Â  Â  Â  data: hazardData,
Â  Â  Â  Â  Â  Â  options: {
Â  Â  Â  Â  Â  Â  Â  Â  responsive: true,
Â  Â  Â  Â  Â  Â  Â  Â  maintainAspectRatio: false,
Â  Â  Â  Â  Â  Â  Â  Â  plugins: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  legend: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  position: 'top',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  labels: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  color: 'var(--color-text-primary)'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  }

Â  Â  const resourceCtx = document.getElementById('resourceChart');
Â  Â  if (resourceCtx && !resourceChart) {
Â  Â  Â  Â  resourceChart = new Chart(resourceCtx, {
Â  Â  Â  Â  Â  Â  type: 'radar',
Â  Â  Â  Â  Â  Â  data: resourceData,
Â  Â  Â  Â  Â  Â  options: {
Â  Â  Â  Â  Â  Â  Â  Â  responsive: true,
Â  Â  Â  Â  Â  Â  Â  Â  maintainAspectRatio: false,
Â  Â  Â  Â  Â  Â  Â  Â  scales: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  r: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  angleLines: { color: 'rgba(255, 255, 255, 0.2)' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  grid: { color: 'rgba(255, 255, 255, 0.2)' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pointLabels: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  color: 'var(--color-text-primary)',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  font: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  family: 'Inter, sans-serif'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ticks: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  color: 'var(--color-text-primary)',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  backdropColor: 'var(--color-bg-dark)'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  plugins: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  legend: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  display: false
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  }
}



// --- Page Navigation ---
export function showPage(targetId) {
Â  Â  const pages = document.querySelectorAll('.page');
Â  Â  const homeDashboard = document.getElementById('home-dashboard');
Â  Â  const navButtons = document.querySelectorAll('.nav-btn');

Â  Â  pages.forEach(page => page.classList.remove('active'));
Â  Â  
Â  Â  if (targetId === 'home-dashboard') { 
Â  Â  Â  Â  homeDashboard.style.display = 'grid'; 
Â  Â  } else {
Â  Â  Â  Â  homeDashboard.style.display = 'none';
Â  Â  Â  Â  const targetPage = document.getElementById(targetId);
Â  Â  Â  Â  if (targetPage) targetPage.classList.add('active');
Â  Â  }
Â  Â  
Â  Â  // Update active nav button
Â  Â  navButtons.forEach(btn => btn.classList.remove('active'));
Â  Â  const activeBtn = document.querySelector(`.nav-btn[data-target="${targetId}"]`);
Â  Â  if(activeBtn) activeBtn.classList.add('active');
}

// --- Event Timeline ---
export function addEventToTimeline(icon, text, type = 'info') {
Â  Â  const eventTimeline = document.getElementById('event-timeline');
Â  Â  const item = document.createElement('div');
Â  Â  item.className = 'timeline-item';
Â  Â  
Â  Â  let iconColor = 'var(--color-success)';
Â  Â  if (type === 'warning') iconColor = 'var(--color-warn)';
Â  Â  if (type === 'danger') iconColor = 'var(--color-alert)';
Â  Â  if (type === 'info') iconColor = 'var(--color-accent)';
Â  Â  
Â  Â  const time = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
Â  Â  
Â  Â  item.innerHTML = `
Â  Â  Â  Â  <div class="timeline-icon" style="color: ${iconColor};">${icon}</div>
Â  Â  Â  Â  <div class="timeline-content">
Â  Â  Â  Â  Â  Â  <p>${text}</p>
Â  Â  Â  Â  Â  Â  <div class="time">${time}</div>
Â  Â  Â  Â  </div>`;
Â  Â  eventTimeline.prepend(item);
}

// --- Alert System ---
export function triggerAlert() {
Â  Â  const alertPopup = document.getElementById('alert-popup');
Â  Â  const alarmSound = document.getElementById('alarm-sound');
Â  Â  
Â  Â  alertPopup.classList.remove('hidden');
Â  Â  alarmSound.play().catch(e => console.error("Error playing sound:", e));
Â  Â  if ('vibrate' in navigator) navigator.vibrate([500, 200, 500]);
Â  Â  
Â  Â  addEventToTimeline('ğŸš¨', 'CRITICAL ALERT: User location is now in high-risk zone!', 'danger');
Â  Â  
Â  Â  // Also show the disaster intel
Â  Â  document.getElementById('disaster-feed-section').classList.remove('hidden');
Â  Â  document.getElementById('history-advisory-section').classList.remove('hidden');
Â  Â  document.getElementById('toggle-advisory-btn').textContent = 'Hide Disaster Intel';
}

export function stopAlert() {
Â  Â  const alertPopup = document.getElementById('alert-popup');
Â  Â  const alarmSound = document.getElementById('alarm-sound');

Â  Â  alertPopup.classList.add('hidden');
Â  Â  alarmSound.pause(); 
Â  Â  alarmSound.currentTime = 0;
Â  Â  if ('vibrate' in navigator) navigator.vibrate(0);
}

// --- Particle Background ---
export function initParticleAnimation() { 
Â  Â  const canvas = document.getElementById('particle-canvas'); 
Â  Â  if (!canvas) return; 
Â  Â  const ctx = canvas.getContext('2d');
Â  Â  canvas.width = window.innerWidth; 
Â  Â  canvas.height = window.innerHeight; 
Â  Â  let particlesArray = []; 
Â  Â  
Â  Â  class Particle { 
Â  Â  Â  Â  constructor(x, y, dirX, dirY, size) { 
Â  Â  Â  Â  Â  Â  this.x = x; this.y = y; this.dirX = dirX; this.dirY = dirY; this.size = size; 
Â  Â  Â  Â  } 
Â  Â  Â  Â  draw() { 
Â  Â  Â  Â  Â  Â  ctx.beginPath(); 
Â  Â  Â  Â  Â  Â  ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2, false); 
Â  Â  Â  Â  Â  Â  ctx.fillStyle = 'rgba(100, 150, 255, 0.2)'; 
Â  Â  Â  Â  Â  Â  ctx.fill(); 
Â  Â  Â  Â  } 
Â  Â  Â  Â  update() { 
Â  Â  Â  Â  Â  Â  if (this.x > canvas.width || this.x < 0) { this.dirX = -this.dirX; } 
Â  Â  Â  Â  Â  Â  if (this.y > canvas.height || this.y < 0) { this.dirY = -this.dirY; } 
Â  Â  Â  Â  Â  Â  this.x += this.dirX; this.y += this.dirY; 
Â  Â  Â  Â  Â  Â  this.draw(); 
Â  Â  Â  Â  } 
Â  Â  }
Â  Â  
Â  Â  function init() { 
Â  Â  Â  Â  particlesArray = []; 
Â  Â  Â  Â  let num = (canvas.height * canvas.width) / 9000; 
Â  Â  Â  Â  for (let i = 0; i < num; i++) { 
Â  Â  Â  Â  Â  Â  let size = (Math.random() * 2) + 1; 
Â  Â  Â  Â  Â  Â  let x = (Math.random() * (innerWidth - size * 2)); 
Â  Â  Â  Â  Â  Â  let y = (Math.random() * (innerHeight - size * 2)); 
Â  Â  Â  Â  Â  Â  let dirX = (Math.random() * 0.4) - 0.2; 
Â  Â  Â  Â  Â  Â  let dirY = (Math.random() * 0.4) - 0.2; 
Â  Â  Â  Â  Â  Â  particlesArray.push(new Particle(x, y, dirX, dirY, size)); 
Â  Â  Â  Â  } 
Â  Â  }
Â  Â  
Â  Â  function animate() { 
Â  Â  Â  Â  requestAnimationFrame(animate); 
Â  Â  Â  Â  ctx.clearRect(0,0,innerWidth, innerHeight); 
Â  Â  Â  Â  particlesArray.forEach(p => p.update()); 
Â  Â  }
Â  Â  
Â  Â  window.addEventListener('resize', () => { 
Â  Â  Â  Â  canvas.width = innerWidth; 
Â  Â  Â  Â  canvas.height = innerHeight; 
Â  Â  Â  Â  init(); 
Â  Â  }); 
Â  Â  
Â  Â  init(); 
Â  Â  animate();
}


these are files in js named as actions.js,api.js,auth.js,chat.js,globe.js,main.js,map.js,state.js,stats.js,ui.js

now index.html
<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>AEGIS Protocol - Command Hub</title>
Â  Â  
Â  Â  <link rel="manifest" href="manifest.json">
Â  Â  <meta name="theme-color" content="#00ffff">
Â  Â  
Â  Â  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet">
Â  Â  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
Â  Â  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
Â  Â  
Â  Â  <link rel="stylesheet" href="style.css">

Â  Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
Â  Â  <script src="https://cdn.jsdelivr.net/npm/three/examples/js/controls/OrbitControls.js"></script>
Â  Â  <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.globe.min.js"></script>
Â  Â  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
Â  Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
Â  Â  
Â  Â  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<body>

Â  Â  <div id="app-background"></div>
Â  Â  <canvas id="particle-canvas"></canvas>

Â  Â  <div id="login-page">
Â  Â  Â  Â  <div class="glass-panel login-box">
Â  Â  Â  Â  Â  Â  <h1 class="font-orbitron">Inceptums</h1>
Â  Â  Â  Â  Â  Â  <p>System Access & Initialization</p>
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  <div class="auth-toggle">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="toggle-to-register" class="auth-toggle-btn active">Register</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="toggle-to-login" class="auth-toggle-btn">Login</button>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <form id="register-form" class="auth-form active">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="reg-name" placeholder="Name" required>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="reg-age" placeholder="Age" required>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="tel" id="reg-mobile" placeholder="Mobile Number" required>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="tel" id="reg-contact" placeholder="Favorite Contact Number" required>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="password" id="reg-password" placeholder="Password" required>
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  <p id="register-error-message" class="error-message"></p>
Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="btn btn-primary">Register Account</button>
Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  <form id="login-form" class="auth-form">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="tel" id="login-mobile" placeholder="Mobile Number" required>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="password" id="login-password" placeholder="Password" required>
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  <p id="login-error-message" class="error-message"></p>
Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="btn btn-primary">Access Dashboard</button>
Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="main-dashboard" class="hidden">
Â  Â  Â  Â  
Â  Â  Â  Â  <nav class="sidebar">
Â  Â  Â  Â  Â  Â  <button data-target="system-screen" class="nav-btn logo" title="System Info">A</button>
Â  Â  Â  Â  Â  Â  <button data-target="home-dashboard" class="nav-btn active" title="Dashboard">
Â  Â  Â  Â  Â  Â  Â  Â  Â <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  <button data-target="module1-screen" class="nav-btn" title="AI Assistant">
Â  Â  Â  Â  Â  Â  Â  Â  Â <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  <button data-target="module2-screen" class="nav-btn" title="Emergency Hub">
Â  Â  Â  Â  Â  Â  Â  Â  Â <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  <button data-target="module3-globe" class="nav-btn" title="Global View">
Â  Â  Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path stroke-linecap="round" stroke-linejoin="round" d="M3.1 9a14.2 14.2 0 0110.4 0m-10.4 6a14.2 14.2 0 0010.4 0m4.5-10.9a14.3 14.3 0 01.6 10.9m0 0a14.3 14.3 0 01-.6 10.9m-9.8 1.4a14.3 14.3 0 01-.6-10.9m0 0a14.3 14.3 0 01.6-10.9" />
Â  Â  Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  </button>

Â  Â  Â  Â  Â  Â  <button data-target="module4-stats" class="nav-btn" title="Stats & Analytics">
Â  Â  Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="24" height="24">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 0 0 6 16.5h12M3.75 3.75h16.5M3.75 12h16.5m-16.5 4.5h16.5M12 16.5v4.5m-4.125-4.5v4.5m8.25-4.5v4.5M3 3h18v18H3V3z" />
Â  Â  Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  </button>

Â  Â  Â  Â  Â  Â  <button id="logout-btn" class="nav-btn" title="Logout">
Â  Â  Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </nav>
Â  Â  Â  Â  
Â  Â  Â  Â  <div id="home-dashboard">
Â  Â  Â  Â  Â  Â  <div class="home-map-container glass-panel">
Â  Â  Â  Â  Â  Â  Â  Â  <div id="map"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="map-controls">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="map-control-group"><button id="btn-theme" class="map-control-btn">ğŸŒ™ Night Mode</button></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="map-control-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="btn-standard" class="map-control-btn active">Standard</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="btn-satellite" class="map-control-btn">Satellite</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="btn-radar" class="map-control-btn">Radar</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="map-control-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="btn-draw-zone" class="map-control-btn">Draw Manual Zone</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  <div class="home-right-column">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="glass-panel">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <header class="home-header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h1 class="font-orbitron">Dashboard</h1>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p id="dashboard-location"></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </header>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="alert-box">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="font-orbitron">High Alert!</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p id="alert-message">A high-risk zone is being monitored.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="timeline-header">Event Timeline</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="event-timeline" class="panel-content-scrollable">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  
Â  Â  Â  Â  <div id="module1-screen" class="page glass-panel">
Â  Â  Â  Â  Â  Â  <button class="nav-back">â† Back to Map</button>
Â  Â  Â  Â  Â  Â  <div id="chat-window-container">
Â  Â  Â  Â  Â  Â  Â  Â  <div id="chat-window">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  <form id="chat-form">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="chat-input" placeholder="Ask for safety advice..."></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="btn btn-primary">Send Query</button>
Â  Â  Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  <div class="chat-sidebar">
Â  Â  Â  Â  Â  Â  Â  Â  <h1 class="font-orbitron">AI Assistant</h1>
Â  Â  Â  Â  Â  Â  Â  Â  <p>Ask for safety advice, resource locations, or evacuation procedures.</p>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="toggle-advisory-btn" class="btn btn-secondary">Show Disaster Intel</button>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="disaster-feed-section" class="sidebar-section hidden">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>Current Disaster Feed</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="video-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <iframe src="https://www.youtube.com/embed/watch?v=A-Xp32FfC1I" frameborder="0" allowfullscreen></iframe>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="history-advisory-section" class="sidebar-section hidden">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>Historical Advisory</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <ul class="history-list">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li><b>Earthquake (2011):</b> Drop, Cover, and Hold On.</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li><b>Flood (2018):</b> Seek higher ground immediately.</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li><b>Wildfire (2020):</b> Evacuate if told. Keep air clean.</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="module2-screen" class="page glass-panel">
Â  Â  Â  Â  Â  Â  Â <button class="nav-back">â† Back to Map</button>
Â  Â  Â  Â  Â  Â  Â <h1 class="module-header font-orbitron">Module 2: Emergency Hub</h1>
Â  Â  Â  Â  Â  Â  Â <div class="hologram-container">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="holo-ring ring1"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="holo-ring ring2"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="sos-button" class="sos-pulse">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="sos-text">SOS</span>
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="module3-globe" class="page glass-panel">
Â  Â  Â  Â  Â  Â  <button class="nav-back">â† Back to Map</button>
Â  Â  Â  Â  Â  Â  <h1 class="module-header font-orbitron" style="color: var(--color-accent);">Global Command</h1>
Â  Â  Â  Â  Â  Â  <div class="globe-module-container">
Â  Â  Â  Â  Â  Â  Â  Â  <div id="globe-module-canvas"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="globe-module-stats glass-panel">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>System Status</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="info-grid">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>Status:</span><span style="color: var(--color-success);">All Systems Nominal</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>Active Zones:</span><span>2</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>Resources:</span><span>4 Deployed</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>Operator:</span><span id="globe-operator-name"></span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="module4-stats" class="page glass-panel">
Â  Â  Â  Â  Â  Â  <button class="nav-back">â† Back to Map</button>
Â  Â  Â  Â  Â  Â  <h1 class="module-header font-orbitron" style="color: var(--color-success);">Data & Analytics</h1>
Â  Â  Â  Â  Â  Â  <div class="stats-grid">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="stats-chart-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>Hazard Types</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="chart-wrapper">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <canvas id="hazardChart"></canvas>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="stats-chart-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>Resource Availability</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="chart-wrapper">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <canvas id="resourceChart"></canvas>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="system-screen" class="page glass-panel">
Â  Â  Â  Â  Â  Â  <button class="nav-back">â† Back to Map</button>
Â  Â  Â  Â  Â  Â  <div class="system-content-wrapper">
Â  Â  Â  Â  Â  Â  Â  Â  <h1 class="font-orbitron">System & Profile</h1>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="profile-section">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>Your Information</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="info-grid">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>Name:</span><span id="profile-name"></span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>Age:</span><span id="profile-age"></span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>Mobile:</span><span id="profile-mobile"></span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>Primary Contact:</span><span id="profile-contact"></span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="profile-section">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>Preparedness Checklist</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <ul class="checklist">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li><input type="checkbox" id="chk-kit"><label for="chk-kit">First-Aid Kit Ready</label></li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li><input type="checkbox" id="chk-docs"><label for="chk-docs">Important Documents Secured</label></li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li><input type="checkbox" id="chk-plan"><label for="chk-plan">Family Evacuation Plan Made</label></li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="profile-section">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>Manage Favorite Contacts</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <form id="additional-contacts-form">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="tel" data-contact-id="2" placeholder="Additional Contact 2" class="additional-contact">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="tel" data-contact-id="3" placeholder="Additional Contact 3" class="additional-contact">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="tel" data-contact-id="4" placeholder="Additional Contact 4" class="additional-contact">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="tel" data-contact-id="5" placeholder="Additional Contact 5" class="additional-contact">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="tel" data-contact-id="6" placeholder="Additional Contact 6" class="additional-contact">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="save-contacts-btn" class="btn btn-primary">Save Contacts</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  </div>
Â  Â  
Â  Â  <div id="alert-popup" class="hidden">
Â  Â  Â  Â  <audio id="alarm-sound" src="https://www.soundjay.com/buttons/beep-01a.mp3" loop></audio>
Â  Â  Â  Â  <div class="alert-popup-box">
Â  Â  Â  Â  Â  Â  <h1 class="font-orbitron">CRITICAL ALERT</h1>
Â  Â  Â  Â  Â  Â  <p>High-Risk Zone has reached your location. Evacuate immediately.</p>
Â  Â  Â  Â  Â  Â  <button id="stop-alert-button">Stop Alarm</button>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <script type="module" src="js/main.js"></script>

Â  Â  <script>
Â  Â  Â  if ('serviceWorker' in navigator) {
Â  Â  Â  Â  window.addEventListener('load', () => {
Â  Â  Â  Â  Â  navigator.serviceWorker.register('/sw.js')
Â  Â  Â  Â  Â  Â  .then(registration => {
Â  Â  Â  Â  Â  Â  Â  console.log('ServiceWorker registration successful: ', registration.scope);
Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  .catch(err => {
Â  Â  Â  Â  Â  Â  Â  console.log('ServiceWorker registration failed: ', err);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  </script>
</body>
</html>

manifest.json
{
Â  "name": "AEGIS Protocol",
Â  "short_name": "AEGIS",
Â  "start_url": "index.html",
Â  "display": "standalone",
Â  "background_color": "#020a18",
Â  "theme_color": "#00ffff",
Â  "orientation": "portrait-primary",
Â  "icons": [
Â  Â  {
Â  Â  Â  "src": "https.cdn-icons-png.flaticon.com/192.png",
Â  Â  Â  "type": "image/png",
Â  Â  Â  "sizes": "192x192",
Â  Â  Â  "purpose": "any maskable"
Â  Â  },
Â  Â  {
Â  Â  Â  "src": "https.cdn-icons-png.flaticon.com/512.png",
Â  Â  Â  "type": "image/png",
Â  Â  Â  "sizes": "512x512",
Â  Â  Â  "purpose": "any maskable"
Â  Â  }
Â  ]
}

style.css
/* === CSS Custom Properties === */
:root {
Â  Â  --font-heading: 'Orbitron', sans-serif;
Â  Â  --font-body: 'Inter', sans-serif;
Â  Â  --color-bg-dark: #020a18;
Â  Â  --color-bg-grid: rgba(0, 150, 255, 0.07);
Â  Â  --color-text-primary: #e6f1ff;
Â  Â  --color-text-secondary: #a8b2d1;
Â  Â  --color-text-dim: #737d9c;
Â  Â  --color-accent: #00ffff;
Â  Â  --color-accent-glow: rgba(0, 255, 255, 0.2);
Â  Â  --color-accent-dark: #0ea5e9;
Â  Â  --color-alert: #f74040;
Â  Â  --color-alert-glow: rgba(247, 64, 64, 0.3);
Â  Â  --color-success: #39ff14;
Â  Â  --color-warn: #ffca3a;
Â  Â  --panel-bg: rgba(10, 25, 47, 0.75);
Â  Â  --panel-blur: blur(12px);
Â  Â  --panel-border: 1px solid rgba(0, 255, 255, 0.25);
Â  Â  --panel-shadow: 0 0 25px rgba(0, 255, 255, 0.1);
}

/* === Base & Background Styles === */
* { box-sizing: border-box; margin: 0; padding: 0; }
html, body {
Â  Â  width: 100vw; height: 100vh; font-family: var(--font-body);
Â  Â  background-color: var(--color-bg-dark); color: var(--color-text-primary); overflow: hidden;
}
#app-background {
Â  Â  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
Â  Â  background-image: linear-gradient(var(--color-bg-grid) 1px, transparent 1px),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  linear-gradient(90deg, var(--color-bg-grid) 1px, transparent 1px);
Â  Â  background-size: 30px 30px; animation: pan-grid 60s linear infinite; z-index: -2;
}

/* Hide default grid/particles on the login page */
.on-login-page #app-background,
.on-login-page #particle-canvas {
Â  Â  display: none;
}
@keyframes pan-grid { from { background-position: 0 0; } to { background-position: 300px 300px; } }

#particle-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; opacity: 0.5; }

/* === Typography === */
.font-orbitron { font-family: var(--font-heading); }
h1, h2, h3, h4, h5 { font-family: var(--font-heading); color: var(--color-accent); letter-spacing: 1px; }

/* === Glass Panel Style === */
.glass-panel {
Â  Â  background: var(--panel-bg); backdrop-filter: var(--panel-blur); border: var(--panel-border);
Â  Â  border-radius: 12px; box-shadow: var(--panel-shadow); padding: 1.5rem;
}

/* === Form & Button Styles === */
input[type="text"], input[type="number"], input[type="tel"], input[type="password"], textarea {
Â  Â  width: 100%; background: rgba(0, 0, 0, 0.3); border: 1px solid var(--color-text-dim);
Â  Â  border-radius: 8px; padding: 0.75rem; color: var(--color-text-primary); font-size: 1rem;
Â  Â  transition: all 0.2s ease; margin-bottom: 1rem;
}
input:focus, textarea:focus { outline: none; border-color: var(--color-accent); box-shadow: 0 0 15px var(--color-accent-glow); }
.btn {
Â  Â  width: 100%; border: none; border-radius: 8px; padding: 0.75rem 1rem; font-family: var(--font-heading);
Â  Â  font-weight: 700; font-size: 1rem; cursor: pointer; transition: all 0.2s ease; text-transform: uppercase;
}
.btn-primary { background-color: var(--color-accent-dark); color: var(--color-text-primary); margin-top: 1.5rem; }
.btn-primary:hover { background-color: var(--color-accent); color: var(--color-bg-dark); box-shadow: 0 0 20px var(--color-accent-glow); }
.btn-secondary { background-color: transparent; border: 1px solid var(--color-accent-dark); color: var(--color-accent-dark); }
.btn-secondary:hover { background-color: var(--color-accent-dark); color: var(--color-text-primary); }

/* === NEW: Form Error Message Style === */
.error-message {
Â  Â  color: var(--color-alert);
Â  Â  text-align: center;
Â  Â  height: 1rem;
Â  Â  font-size: 0.9rem;
Â  Â  margin-bottom: 0.5rem;
}

/* === Login Page === */
#login-page {
Â  Â  height: 100vh;
Â  Â  width: 100vw;
Â  Â  display: flex;
Â  Â  align-items: center;
Â  Â  justify-content: center;
Â  Â  padding: 1rem;
Â  Â  position: relative; 
Â  Â  overflow: hidden;
Â  Â  /* Vanta.js will attach to this element */
}

.login-box {
Â  Â  width: 100%;
Â  Â  max-width: 420px;
Â  Â  position: relative;
Â  Â  z-index: 10;
}
.login-box h1 { font-size: 2.25rem; text-align: center; margin-bottom: 0.5rem; }
.login-box p { text-align: center; color: var(--color-text-secondary); margin-bottom: 2rem; }

/* Auth Toggle Buttons */
.auth-toggle {
Â  Â  display: flex;
Â  Â  border-bottom: 1px solid var(--color-accent-glow);
Â  Â  margin-bottom: 1.5rem;
}
.auth-toggle-btn {
Â  Â  flex: 1;
Â  Â  background: none;
Â  Â  border: none;
Â  Â  color: var(--color-text-dim);
Â  Â  padding: 0.75rem;
Â  Â  font-family: var(--font-heading);
Â  Â  font-size: 1rem;
Â  Â  cursor: pointer;
Â  Â  transition: all 0.2s ease;
}
.auth-toggle-btn.active {
Â  Â  color: var(--color-accent);
Â  Â  border-bottom: 2px solid var(--color-accent);
Â  Â  box-shadow: 0 5px 15px var(--color-accent-glow);
}
.auth-form {
Â  Â  display: none; /* Hidden by default */
}
.auth-form.active {
Â  Â  display: block; /* Shown when active */
}


/* === Main Dashboard Layout === */
#main-dashboard { display: flex; height: 100vh; }
.hidden { display: none !important; }

/* === Sidebar Navigation === */
.sidebar {
Â  Â  width: 80px; background: var(--panel-bg); backdrop-filter: var(--panel-blur); border-right: var(--panel-border);
Â  Â  box-shadow: var(--panel-shadow); display: flex; flex-direction: column; align-items: center;
Â  Â  padding: 1.5rem 0; gap: 1rem; z-index: 30;
}
.nav-btn {
Â  Â  padding: 0.75rem; border-radius: 8px; color: var(--color-text-dim); transition: all 0.2s ease;
Â  Â  text-decoration: none; background: none; border: none; cursor: pointer;
}
.nav-btn.logo {
Â  Â  font-family: var(--font-heading); font-weight: 900; font-size: 2rem; color: var(--color-accent); line-height: 1;
}
.nav-btn.logo:hover { transform: scale(1.1); text-shadow: 0 0 15px var(--color-accent); }
.nav-btn.active, .nav-btn:hover { background-color: var(--color-accent-dark); color: var(--color-text-primary); box-shadow: 0 0 15px var(--color-accent-glow); }
.nav-btn svg { width: 24px; height: 24px; }

/* Logout Button */
#logout-btn {
Â  Â  margin-top: auto; /* Pushes to the bottom */
}

/* === Home Dashboard Screen === */
#home-dashboard { flex: 1; display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; padding: 1.5rem; height: 100vh; overflow: hidden; }
.home-map-container { position: relative; border-radius: 12px; overflow: hidden; border: var(--panel-border); }
#map { height: 100%; width: 100%; z-index: 1; }
.home-right-column { height: 100%; display: flex; flex-direction: column; gap: 1.5rem; }
.home-right-column .glass-panel { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
.panel-content-scrollable { overflow-y: auto; flex-grow: 1; padding-right: 0.5rem; }
.home-header h1 { font-size: 2rem; margin-bottom: 0.25rem; }
.home-header p { color: var(--color-text-secondary); margin-bottom: 1.5rem; }
.alert-box { background: rgba(239, 68, 68, 0.15); border: 1px solid var(--color-alert); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem; }
.alert-box h2 { color: var(--color-alert); font-size: 1.1rem; }
.alert-box p { color: var(--color-text-primary); font-size: 0.9rem; }
.timeline-header { font-size: 1.25rem; color: var(--color-accent); margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--color-accent-glow); }

/* Map Controls */
#map-controls { position: absolute; top: 1rem; right: 1rem; z-index: 401; display: flex; flex-direction: column; gap: 0.5rem; }
.map-control-group { background: var(--panel-bg); backdrop-filter: var(--panel-blur); border: 1px solid var(--color-accent-glow); border-radius: 8px; overflow: hidden; }
.map-control-btn { padding: 6px 12px; background: none; border: none; color: var(--color-text-secondary); font-size: 0.8rem; font-weight: 500; cursor: pointer; width: 100%; text-align: left; border-bottom: 1px solid var(--color-accent-glow); }
.map-control-group button:last-child { border-bottom: none; }
.map-control-btn.active, .map-control-btn:hover { background-color: var(--color-accent-dark); color: white; }
.leaflet-container.dark-theme { background: #1f2937; }
.leaflet-container.light-theme { background: #d1d5db; }
.leaflet-draw-toolbar { display: none !important; } /* Hide default Leaflet.draw toolbar */

/* === Full Screen Page Modules === */
.page { position: absolute; top: 0; left: 80px; width: calc(100vw - 80px); height: 100vh; display: flex; flex-direction: column; opacity: 0; visibility: hidden; transition: opacity 0.4s ease, transform 0.4s ease; z-index: 20; padding: 2rem; }
#module1-screen { transform: translateX(50px); }
#module2-screen { transform: scale(0.95); }
#module3-globe { transform: scale(0.9); }
#system-screen { transform: scale(1.1); }
.page.active { opacity: 1; visibility: visible; transform: scale(1) translateX(0); }
.nav-back { position: absolute; top: 2rem; left: 2rem; z-index: 10; color: var(--color-accent); background: none; border: none; cursor: pointer; font-size: 1rem; font-family: var(--font-heading); }
.nav-back:hover { text-decoration: underline; }
.module-header { position: absolute; top: 2rem; font-size: 2.5rem; } /* Shared */


/* === Module 1: AI Assistant === */
#module1-screen { flex-direction: row; gap: 1.5rem; padding-top: 5rem; }
#chat-window-container { flex: 2; height: 100%; display: flex; flex-direction: column; }
#chat-window { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 0.75rem; padding-right: 1rem; }
.chat-sidebar { flex: 1; border-left: var(--panel-border); padding-left: 1.5rem; height: 100%; overflow-y: auto; }
.chat-sidebar h1 { font-size: 1.5rem; margin-bottom: 0.5rem; }
#chat-form { display: flex; flex-direction: column; gap: 1rem; margin-top: 1rem; }
#chat-input { height: 120px; }
.chat-msg-wrapper { display: flex; }
.chat-msg-wrapper.user { justify-content: flex-end; }
.chat-msg-wrapper.ai { justify-content: flex-start; }
.chat-msg { max-width: 85%; padding: 0.75rem 1rem; border-radius: 10px; font-size: 0.9rem; line-height: 1.5; }
.chat-msg.user { background-color: var(--color-accent-dark); color: white; border-bottom-right-radius: 0; }
.chat-msg.ai { background-color: #1f2937; color: var(--color-text-secondary); border-bottom-left-radius: 0; }
.chat-msg ul { padding-left: 1.25rem; margin-top: 0.5rem; }
.chat-msg h4 { color: var(--color-accent); font-size: 0.9rem; margin-top: 0.75rem; }
.video-container { position: relative; overflow: hidden; width: 100%; padding-top: 56.25%; margin-top: 0.5rem; border-radius: 8px; }
.video-container iframe { position: absolute; top: 0; left: 0; bottom: 0; right: 0; width: 100%; height: 100%; border-radius: 0.5rem; }
.sidebar-section { background: rgba(31, 41, 55, 0.7); border: 1px solid rgba(55, 65, 81, 0.5); border-radius: 8px; padding: 1rem; margin-top: 1.5rem; }
.sidebar-section h2 { font-size: 1.1rem; margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--color-text-dim); }
.history-list { list-style: none; padding-left: 0; }
.history-list li { position: relative; padding-left: 1.5rem; margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--color-text-secondary); }
.history-list li::before { content: 'Â»'; position: absolute; left: 0; top: 0; color: var(--color-accent); font-weight: 700; }
#toggle-advisory-btn { width: 100%; margin-top: 1.5rem; font-size: 0.9rem; }

/* === Module 2: Emergency Hub === */
#module2-screen { align-items: center; justify-content: center; text-align: center; }
#module2-screen .module-header { color: var(--color-alert); }
#sos-button { width: 250px; height: 250px; background-color: var(--color-alert); border-radius: 50%; border: none; color: white; font-family: var(--font-heading); font-weight: 700; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: all 0.3s ease; z-index: 10; }
#sos-text { font-size: 5rem; }
.sos-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
@keyframes pulse { 0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 50% { transform: scale(1.05); box-shadow: 0 0 0 30px rgba(239, 68, 68, 0); } }
.hologram-container { position: relative; width: 400px; height: 400px; display: flex; align-items: center; justify-content: center; }
.holo-ring { position: absolute; border-radius: 50%; border: 2px solid var(--color-alert-glow); box-shadow: 0 0 15px var(--color-alert-glow); }
.ring1 { width: 320px; height: 320px; border-width: 3px; border-style: dashed; animation: spin 20s linear infinite; }
.ring2 { width: 380px; height: 380px; border-style: solid; opacity: 0.5; animation: spin 15s linear infinite reverse; }
@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

/* === Module 3 - Globe === */
#module3-globe {
Â  Â  flex-direction: column;
Â  Â  align-items: center;
Â  Â  justify-content: center;
Â  Â  padding-top: 5rem;
}
#module3-globe .module-header {
Â  Â  color: var(--color-accent);
}
.globe-module-container {
Â  Â  display: flex;
Â  Â  flex-direction: column;
Â  Â  align-items: center;
Â  Â  justify-content: center;
Â  Â  width: 100%;
Â  Â  height: 100%;
Â  Â  gap: 2rem;
}
#globe-module-canvas {
Â  Â  width: 100%;
Â  Â  max-width: 500px; /* Globe size */
Â  Â  height: 500px;
Â  Â  position: relative;
}
#globe-module-canvas canvas {
Â  Â  width: 100% !important;
Â  Â  height: 100% !important;
}
.globe-module-stats {
Â  Â  width: 100%;
Â  Â  max-width: 500px;
Â  Â  background: rgba(31, 41, 55, 0.7);
Â  Â  border: 1px solid rgba(55, 65, 81, 0.5);
}
.globe-module-stats h2 {
Â  Â  font-size: 1.1rem;
Â  Â  margin-bottom: 1rem;
Â  Â  padding-bottom: 0.5rem;
Â  Â  border-bottom: 1px solid var(--color-text-dim);
}

/* === Module 3 (now 4): System & Profile === */
#system-screen { align-items: center; padding-top: 5rem; }
.system-content-wrapper { width: 100%; max-width: 768px; height: 100%; overflow-y: auto; padding-right: 1rem; }
.system-content-wrapper h1 { font-size: 1.5rem; margin-bottom: 1.5rem; }
.profile-section { background: rgba(31, 41, 55, 0.7); border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem; border: 1px solid rgba(55, 65, 81, 0.5); }
.profile-section h2 { font-size: 1.1rem; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--color-text-dim); }
.info-grid { display: grid; grid-template-columns: auto 1fr; gap: 0.5rem 1rem; font-size: 0.9rem; font-family: 'Roboto Mono', monospace; }
.info-grid span:nth-child(odd) { color: var(--color-text-dim); }
.info-grid span:nth-child(even) { color: var(--color-text-primary); font-weight: 500; }
.checklist li { display: flex; align-items: center; margin-bottom: 0.75rem; }
.checklist input[type="checkbox"] { width: 1.1rem; height: 1.1rem; accent-color: var(--color-accent); margin-right: 0.75rem; }
#additional-contacts-form input { margin-bottom: 0.5rem; }
#save-contacts-btn { margin-top: 1rem; }

/* === Timeline (in both home and module) === */
.timeline-item { display: flex; align-items: start; padding: 0.75rem 0; border-bottom: 1px solid rgba(55, 65, 81, 0.5); font-size: 0.9rem; }
.timeline-item:first-child { border-top: 1px solid rgba(55, 65, 81, 0.5); }
.timeline-icon { flex-shrink: 0; width: 1.5rem; text-align: center; margin-right: 0.75rem; }
.timeline-content .time { font-family: 'Roboto Mono', monospace; font-size: 0.75rem; color: #9ca3af; margin-top: 0.25rem; }

/* === Alert Popup === */
#alert-popup { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 50; display: flex; align-items: center; justify-content: center; }
.alert-popup-box { background: var(--color-alert); padding: 2.5rem; border-radius: 12px; text-align: center; color: white; box-shadow: 0 0 50px var(--color-alert-glow); }
.alert-popup-box h1 { font-size: 3rem; color: white; }
.alert-popup-box p { font-size: 1.25rem; margin-top: 1rem; color: white; }
#stop-alert-button { margin-top: 2rem; padding: 0.75rem 1.5rem; font-size: 1rem; background: white; color: var(--color-alert); font-weight: 700; border-radius: 8px; border: none; cursor: pointer; }

/* Scrollbar styles */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background-color: var(--color-accent); border-radius: 3px; }
/* ... (all your existing CSS) ... */

/* === Module 4: Stats === */
#module4-stats {
Â  Â  padding-top: 5rem;
}
.stats-grid {
Â  Â  display: grid;
Â  Â  grid-template-columns: 1fr 1fr;
Â  Â  gap: 2rem;
Â  Â  width: 100%;
Â  Â  height: calc(100% - 3rem); /* Subtract header height */
Â  Â  padding: 1rem;
}
.stats-chart-container {
Â  Â  background: rgba(31, 41, 55, 0.7);
Â  Â  border: 1px solid rgba(55, 65, 81, 0.5);
Â  Â  border-radius: 8px;
Â  Â  padding: 1.5rem;
Â  Â  display: flex;
Â  Â  flex-direction: column;
}
.stats-chart-container h2 {
Â  Â  font-size: 1.1rem;
Â  Â  margin-bottom: 1.5rem;
Â  Â  padding-bottom: 0.5rem;
Â  Â  border-bottom: 1px solid var(--color-text-dim);
}
.chart-wrapper {
Â  Â  position: relative;
Â  Â  flex-grow: 1;
Â  Â  min-height: 300px; /* Ensure chart has space */
}


sw.js
const CACHE_NAME = 'aegis-cache-v1';
// All the files your app needs to work offline
const FILES_TO_CACHE = [
Â  'index.html',
Â  'style.css',
Â  'manifest.json',
Â  'js/main.js',
Â  'js/auth.js',
Â  'js/actions.js',
Â  'js/api.js',
Â  'js/chat.js',
Â  'js/globe.js',
Â  'js/map.js',
Â  'js/state.js',
Â  'js/ui.js',
Â  'https.unpkg.com/leaflet@1.9.4/dist/leaflet.css',
Â  'https.unpkg.com/leaflet@1.9.4/dist/leaflet.js'
Â  // You would add all other external libraries here (three.js, etc.)
Â  // and any local image/font files.
];

// 1. Install the Service Worker
self.addEventListener('install', (evt) => {
Â  console.log('[ServiceWorker] Install');
Â  // Pre-cache all essential app files
Â  evt.waitUntil(
Â  Â  caches.open(CACHE_NAME).then((cache) => {
Â  Â  Â  console.log('[ServiceWorker] Pre-caching offline page');
Â  Â  Â  return cache.addAll(FILES_TO_CACHE);
Â  Â  })
Â  );
Â  self.skipWaiting();
});

// 2. Activate the Service Worker
self.addEventListener('activate', (evt) => {
Â  console.log('[ServiceWorker] Activate');
Â  // Remove old, unused caches
Â  evt.waitUntil(
Â  Â  caches.keys().then((keyList) => {
Â  Â  Â  return Promise.all(keyList.map((key) => {
Â  Â  Â  Â  if (key !== CACHE_NAME) {
Â  Â  Â  Â  Â  console.log('[ServiceWorker] Removing old cache', key);
Â  Â  Â  Â  Â  return caches.delete(key);
Â  Â  Â  Â  }
Â  Â  Â  }));
Â  Â  })
Â  );
Â  self.clients.claim();
});

// 3. Serve cached content
self.addEventListener('fetch', (evt) => {
Â  // Try to get from network first, then fall back to cache
Â  evt.respondWith(
Â  Â  caches.match(evt.request)
Â  Â  Â  .then((response) => {
Â  Â  Â  Â  return response || fetch(evt.request);
Â  Â  Â  })
Â  );
});


its my code for my app or website can you give a discription and ideas based on my work